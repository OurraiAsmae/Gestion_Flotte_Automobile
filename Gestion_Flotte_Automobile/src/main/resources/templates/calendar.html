<!DOCTYPE html>
<html th:replace="~{layout/layout :: layout(~{::content})}" xmlns:th="http://www.thymeleaf.org">

<body>
    <div th:fragment="content">
        <!-- Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm mb-3">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <h2 class="text-primary mb-0"><i class="bi bi-calendar-week me-2"></i>Calendrier</h2>

                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="filterPersonal" value="PERSONAL"
                                checked>
                            <label class="form-check-label badge bg-primary" for="filterPersonal">Mes
                                Réservations</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="filterReturn" value="RETURN" checked>
                            <label class="form-check-label badge bg-danger" for="filterReturn">Retours Voitures</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="filterMaintenance" value="MAINTENANCE"
                                checked>
                            <label class="form-check-label badge bg-warning text-dark"
                                for="filterMaintenance">Entretiens</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="filterAssurance" value="ASSURANCE"
                                checked>
                            <label class="form-check-label badge" style="background-color: purple; color: white;"
                                for="filterAssurance">Assurance</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Container -->
        <div class="card shadow-sm border-0">
            <div class="card-body p-0">
                <div id='calendar' style="min-height: 800px;"></div>
            </div>
        </div>

        <!-- Event Details Modal -->
        <div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="eventModalLabel">Détails de l'événement</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Type:</strong> <span id="eventType"></span></p>
                        <p><strong>Date:</strong> <span id="eventDate"></span></p>
                        <div class="alert alert-secondary mt-3">
                            <p id="eventDescription" class="mb-0" style="white-space: pre-line;"></p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- FullCalendar CDN -->
        <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                var calendarEl = document.getElementById('calendar');
                var allEvents = [];
                var eventModal = new bootstrap.Modal(document.getElementById('eventModal'));

                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    locale: 'fr',
                    buttonText: {
                        today: "Aujourd'hui",
                        month: 'Mois',
                        week: 'Semaine',
                        day: 'Jour'
                    },
                    // Manually handle events fetching to support filtering
                    events: function (info, successCallback, failureCallback) {
                        fetch('/calendar/events')
                            .then(response => response.json())
                            .then(data => {
                                allEvents = data;
                                successCallback(filterEvents(data));
                            })
                            .catch(error => failureCallback(error));
                    },
                    eventTimeFormat: {
                        hour: '2-digit',
                        minute: '2-digit',
                        meridiem: false
                    },
                    eventClick: function (info) {
                        // Populate Modal
                        document.getElementById('eventModalLabel').textContent = info.event.title;
                        document.getElementById('eventDate').textContent = info.event.start.toLocaleDateString() +
                            (info.event.end ? ' - ' + info.event.end.toLocaleDateString() : '');

                        // Access extended props
                        document.getElementById('eventType').textContent = info.event.extendedProps.type;
                        document.getElementById('eventDescription').textContent = info.event.extendedProps.description;

                        eventModal.show();
                    }
                });
                calendar.render();

                // Filters Logic
                function filterEvents(events) {
                    var showPersonal = document.getElementById('filterPersonal').checked;
                    var showReturn = document.getElementById('filterReturn').checked;
                    var showReturn = document.getElementById('filterReturn').checked;
                    var showMaintenance = document.getElementById('filterMaintenance').checked;
                    var showAssurance = document.getElementById('filterAssurance').checked;

                    return events.filter(function (event) {
                        if (event.type === 'PERSONAL' && !showPersonal) return false;
                        if (event.type === 'RETURN' && !showReturn) return false;
                        if (event.type === 'MAINTENANCE' && !showMaintenance) return false;
                        if (event.type === 'ASSURANCE' && !showAssurance) return false;
                        return true;
                        return true;
                    });
                }

                // Add Event Listeners to Checkboxes
                var checkboxes = document.querySelectorAll('.form-check-input');
                checkboxes.forEach(function (box) {
                    box.addEventListener('change', function () {
                        calendar.refetchEvents(); // Re-runs the 'events' function
                    });
                });
            });
        </script>

        <style>
            .fc-event {
                cursor: pointer;
            }

            .fc-toolbar-title {
                font-size: 1.5rem !important;
            }

            .fc-button-primary {
                background-color: var(--primary-color, #0d6efd) !important;
                border-color: var(--primary-color, #0d6efd) !important;
            }
        </style>
    </div>
</body>

</html>