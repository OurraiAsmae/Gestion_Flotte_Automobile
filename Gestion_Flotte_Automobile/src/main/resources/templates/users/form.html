<!DOCTYPE html>
<html th:replace="~{layout/layout :: layout(~{::content})}">

<body th:remove="tag">
    <div th:fragment="content">
        <div class="card">
            <div class="card-header">
                <h3 th:text="${user.id == null ? 'Ajouter un utilisateur' : 'Modifier l''utilisateur'}"></h3>
            </div>
            <div class="card-body">
                <!-- Fix th:action using conditional operator -->
                <form th:action="${user.id == null} ? @{/users} : @{/users/update/{id}(id=${user.id})}"
                    th:object="${user}" method="post">
                    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
                    <div class="mb-3">
                        <label for="nom" class="form-label">Nom</label>
                        <input type="text" class="form-control" id="nom" th:field="*{nom}"
                            th:classappend="${#fields.hasErrors('nom')} ? 'is-invalid' : ''" required>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('nom')}" th:errors="*{nom}"></div>
                    </div>
                    <div class="mb-3">
                        <label for="prenom" class="form-label">Prénom</label>
                        <input type="text" class="form-control" id="prenom" th:field="*{prenom}"
                            th:classappend="${#fields.hasErrors('prenom')} ? 'is-invalid' : ''" required>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('prenom')}" th:errors="*{prenom}">
                        </div>
                    </div>
                    <!-- Fix email field -->
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" th:field="*{email}"
                            th:classappend="${#fields.hasErrors('email')} ? 'is-invalid' : ''" required>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>
                    </div>
                    <!-- Password field only for new users -->
                    <div class="mb-3" th:if="${user.id == null}">
                        <label for="motDePasse" class="form-label">Mot de passe</label>
                        <input type="password" class="form-control" id="motDePasse" th:field="*{motDePasse}"
                            th:classappend="${#fields.hasErrors('motDePasse')} ? 'is-invalid' : ''" required>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('motDePasse')}"
                            th:errors="*{motDePasse}">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="telephone" class="form-label">Téléphone</label>
                        <input type="text" class="form-control" id="telephone" th:field="*{telephone}"
                            th:classappend="${#fields.hasErrors('telephone')} ? 'is-invalid' : ''">
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('telephone')}"
                            th:errors="*{telephone}">
                        </div>
                    </div>
                    <!-- Role Selection -->
                    <div class="mb-3">
                        <label for="role" class="form-label">Rôle</label>
                        <select class="form-select" id="role" th:field="*{role}"
                            th:classappend="${#fields.hasErrors('role')} ? 'is-invalid' : ''">
                            <option value="">-- Sélectionner un rôle --</option>
                            <option th:each="r : ${roles}" th:value="${r}" th:text="${r}"></option>
                        </select>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('role')}" th:errors="*{role}"></div>
                    </div>
                    <!-- Statut Selection -->
                    <div class="mb-3">
                        <label for="statut" class="form-label">Statut</label>
                        <select class="form-select" id="statut" th:field="*{statut}"
                            th:classappend="${#fields.hasErrors('statut')} ? 'is-invalid' : ''">
                            <option value="">-- Sélectionner un statut --</option>
                            <option th:each="s : ${statuts}" th:value="${s}" th:text="${s}"></option>
                        </select>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('statut')}" th:errors="*{statut}">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                    <a th:href="@{/users}" class="btn btn-secondary">Annuler</a>
                </form>
            </div>
        </div>
    </div>
</body>

</html>